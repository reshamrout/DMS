<div class="card card-soft" *ngIf="document as doc">
  <div class="card-body p-4">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
      <div>
        <h3>{{ doc.title }}</h3>
        <p class="text-muted">Uploaded by {{ doc.uploadedBy?.name }} | v{{ doc.version }}</p>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" type="button" [disabled]="downloading" (click)="download()">
          {{ downloading ? 'Downloading...' : 'Download' }}
        </button>
        <a class="btn btn-outline-secondary btn-sm" [routerLink]="['/documents', doc._id, 'versions']">Version History</a>
        <button *ngIf="canEdit()" class="btn btn-primary btn-sm" (click)="editMode = !editMode">{{ editMode ? 'Cancel' : 'Edit' }}</button>
        <button *ngIf="canDelete()" class="btn btn-outline-danger btn-sm" (click)="deleteDocument()">Delete</button>
      </div>
    </div>

    <div class="mt-3">
      <p><strong>Description:</strong> {{ doc.description || 'N/A' }}</p>
      <p><strong>Tags:</strong> {{ doc.tags.join(', ') || 'N/A' }}</p>
      <p><strong>View Access:</strong> {{ (doc.viewEmails || []).join(', ') || 'Only owner' }}</p>
      <p><strong>Edit Access:</strong> {{ (doc.editEmails || []).join(', ') || 'Only owner' }}</p>
    </div>

    <div class="mt-4" *ngIf="previewUrl() as url">
      <h6>Preview</h6>
      <img *ngIf="doc.mimeType.startsWith('image/')" [src]="url" class="img-fluid rounded border" />
      <iframe *ngIf="doc.mimeType === 'application/pdf'" [src]="url" class="w-100 border rounded" style="height: 500px"></iframe>
    </div>

    <div class="mt-4 p-3 border rounded" *ngIf="editMode">
      <h5>Edit Document</h5>
      <form [formGroup]="editForm" (ngSubmit)="save()">
        <div class="mb-2"><input formControlName="title" class="form-control" /></div>
        <div class="mb-2"><textarea formControlName="description" rows="4" class="form-control"></textarea></div>
        <div class="mb-2"><input formControlName="tags" class="form-control" /></div>
        <div class="mb-2" *ngIf="canManageAccess()">
          <input formControlName="accessEmails" class="form-control" placeholder="Access emails (comma separated)" />
        </div>
        <div class="mb-2" *ngIf="canManageAccess()">
          <div class="d-flex gap-3">
            <label><input type="checkbox" formControlName="allowView" /> View</label>
            <label><input type="checkbox" formControlName="allowEdit" /> Edit</label>
          </div>
        </div>
        <div class="mb-2"><input type="file" class="form-control" (change)="onFileChange($event)" /></div>
        <button class="btn btn-success btn-sm" type="submit">Save New Version</button>
      </form>
    </div>
  </div>
</div>

<div *ngIf="loading" class="text-muted">Loading document...</div>
