{
  "version": 3,
  "sources": ["src/app/core/services/auth.service.ts"],
  "sourcesContent": ["import { HttpClient } from '@angular/common/http';\nimport { Injectable } from '@angular/core';\nimport { Router } from '@angular/router';\nimport { BehaviorSubject, Observable, tap } from 'rxjs';\nimport { environment } from '../../../environments/environment';\nimport { AuthResponse } from '../../models/auth.model';\nimport { User, UserRole } from '../../models/user.model';\n\n@Injectable({ providedIn: 'root' })\nexport class AuthService {\n  private readonly tokenKey = 'dms_token';\n  private readonly userKey = 'dms_user';\n\n  private userSubject = new BehaviorSubject<User | null>(this.getStoredUser());\n\n  constructor(private http: HttpClient, private router: Router) {\n    if (typeof window !== 'undefined') {\n      window.addEventListener('storage', this.handleStorageChange);\n    }\n  }\n\n  register(payload: { name: string; email: string; password: string }): Observable<AuthResponse> {\n    return this.http.post<AuthResponse>(`${environment.apiUrl}/auth/register`, payload).pipe(\n      tap((response) => this.persistAuth(response))\n    );\n  }\n\n  login(payload: { email: string; password: string }): Observable<AuthResponse> {\n    return this.http.post<AuthResponse>(`${environment.apiUrl}/auth/login`, payload).pipe(\n      tap((response) => this.persistAuth(response))\n    );\n  }\n\n  logout(): void {\n    localStorage.removeItem(this.tokenKey);\n    localStorage.removeItem(this.userKey);\n    this.userSubject.next(null);\n  }\n\n  refreshProfile(): Observable<{ user: User }> {\n    return this.http.get<{ user: User }>(`${environment.apiUrl}/auth/profile`).pipe(\n      tap((res) => {\n        this.userSubject.next(res.user);\n        localStorage.setItem(this.userKey, JSON.stringify(res.user));\n      })\n    );\n  }\n\n  token(): string | null {\n    return localStorage.getItem(this.tokenKey);\n  }\n\n  currentUser(): User | null {\n    return this.userSubject.value;\n  }\n\n  user$(): Observable<User | null> {\n    return this.userSubject.asObservable();\n  }\n\n  isAuthenticated(): boolean {\n    return !!this.token();\n  }\n\n  hasRole(roles: UserRole[]): boolean {\n    const user = this.currentUser();\n    return !!user && roles.includes(user.role);\n  }\n\n  private persistAuth(response: AuthResponse): void {\n    localStorage.setItem(this.tokenKey, response.token);\n    localStorage.setItem(this.userKey, JSON.stringify(response.user));\n    this.userSubject.next(response.user);\n  }\n\n  private getStoredUser(): User | null {\n    const raw = localStorage.getItem(this.userKey);\n    if (!raw) return null;\n\n    try {\n      return JSON.parse(raw) as User;\n    } catch {\n      this.logout();\n      this.router.navigate(['/auth/login']);\n      return null;\n    }\n  }\n\n  private handleStorageChange = (event: StorageEvent): void => {\n    if (event.key !== this.tokenKey && event.key !== this.userKey) return;\n\n    const token = localStorage.getItem(this.tokenKey);\n    const user = this.getStoredUser();\n\n    if (!token || !user) {\n      this.userSubject.next(null);\n      this.router.navigate(['/auth/login']);\n      return;\n    }\n\n    this.userSubject.next(user);\n  };\n}\n"],
  "mappings": ";;;;;;;;;;;AASM,IAAO,cAAP,MAAO,aAAW;EAMtB,YAAoB,MAA0B,QAAc;AAAxC,SAAA,OAAA;AAA0B,SAAA,SAAA;AAL7B,SAAA,WAAW;AACX,SAAA,UAAU;AAEnB,SAAA,cAAc,IAAI,gBAA6B,KAAK,cAAa,CAAE;AA2EnE,SAAA,sBAAsB,CAAC,UAA6B;AAC1D,UAAI,MAAM,QAAQ,KAAK,YAAY,MAAM,QAAQ,KAAK;AAAS;AAE/D,YAAM,QAAQ,aAAa,QAAQ,KAAK,QAAQ;AAChD,YAAM,OAAO,KAAK,cAAa;AAE/B,UAAI,CAAC,SAAS,CAAC,MAAM;AACnB,aAAK,YAAY,KAAK,IAAI;AAC1B,aAAK,OAAO,SAAS,CAAC,aAAa,CAAC;AACpC;MACF;AAEA,WAAK,YAAY,KAAK,IAAI;IAC5B;AArFE,QAAI,OAAO,WAAW,aAAa;AACjC,aAAO,iBAAiB,WAAW,KAAK,mBAAmB;IAC7D;EACF;EAEA,SAAS,SAA0D;AACjE,WAAO,KAAK,KAAK,KAAmB,GAAG,YAAY,MAAM,kBAAkB,OAAO,EAAE,KAClF,IAAI,CAAC,aAAa,KAAK,YAAY,QAAQ,CAAC,CAAC;EAEjD;EAEA,MAAM,SAA4C;AAChD,WAAO,KAAK,KAAK,KAAmB,GAAG,YAAY,MAAM,eAAe,OAAO,EAAE,KAC/E,IAAI,CAAC,aAAa,KAAK,YAAY,QAAQ,CAAC,CAAC;EAEjD;EAEA,SAAM;AACJ,iBAAa,WAAW,KAAK,QAAQ;AACrC,iBAAa,WAAW,KAAK,OAAO;AACpC,SAAK,YAAY,KAAK,IAAI;EAC5B;EAEA,iBAAc;AACZ,WAAO,KAAK,KAAK,IAAoB,GAAG,YAAY,MAAM,eAAe,EAAE,KACzE,IAAI,CAAC,QAAO;AACV,WAAK,YAAY,KAAK,IAAI,IAAI;AAC9B,mBAAa,QAAQ,KAAK,SAAS,KAAK,UAAU,IAAI,IAAI,CAAC;IAC7D,CAAC,CAAC;EAEN;EAEA,QAAK;AACH,WAAO,aAAa,QAAQ,KAAK,QAAQ;EAC3C;EAEA,cAAW;AACT,WAAO,KAAK,YAAY;EAC1B;EAEA,QAAK;AACH,WAAO,KAAK,YAAY,aAAY;EACtC;EAEA,kBAAe;AACb,WAAO,CAAC,CAAC,KAAK,MAAK;EACrB;EAEA,QAAQ,OAAiB;AACvB,UAAM,OAAO,KAAK,YAAW;AAC7B,WAAO,CAAC,CAAC,QAAQ,MAAM,SAAS,KAAK,IAAI;EAC3C;EAEQ,YAAY,UAAsB;AACxC,iBAAa,QAAQ,KAAK,UAAU,SAAS,KAAK;AAClD,iBAAa,QAAQ,KAAK,SAAS,KAAK,UAAU,SAAS,IAAI,CAAC;AAChE,SAAK,YAAY,KAAK,SAAS,IAAI;EACrC;EAEQ,gBAAa;AACnB,UAAM,MAAM,aAAa,QAAQ,KAAK,OAAO;AAC7C,QAAI,CAAC;AAAK,aAAO;AAEjB,QAAI;AACF,aAAO,KAAK,MAAM,GAAG;IACvB,QAAQ;AACN,WAAK,OAAM;AACX,WAAK,OAAO,SAAS,CAAC,aAAa,CAAC;AACpC,aAAO;IACT;EACF;;;uBA7EW,cAAW,mBAAA,UAAA,GAAA,mBAAA,MAAA,CAAA;IAAA;EAAA;;4EAAX,cAAW,SAAX,aAAW,WAAA,YADE,OAAM,CAAA;EAAA;;",
  "names": []
}
